<!DOCTYPE html>
<link rel="stylesheet" href="style.css">

<table>
    <th>Account</th>
    <th>Category</th>
    <th>Amount<br>Transferred</th>
    <th>Amount<br>Categorized</th>
    <tr id="adder-row" style="text-align:right;">
        <td colspan="6"><button id="addrow">+</button></td>
    </tr>
</table>

<script>
    "use strict";
    function E(tag, attributes, ...contents) {
        var element = document.createElement(tag);
        if (attributes?.constructor === Object) {
            for (const [name, value] of Object.entries(attributes)) {
                const type = typeof value;
                if (value === true) {
                    element.setAttribute(name, '');
                } else if (value === false) {
                } else if (type === 'function') {
                    element.addEventListener(name, value);
                } else if (type === 'string' || type === 'number') {
                    element.setAttribute(name, value);
                } else {
                    throw new Error(`Unexpected attribute '${value}'`)
                }
            }
        } else if (attributes) {
            element.append(attributes);
        }
        element.append(...contents);
        return element;
    }

    var categories = ["Salary", "Food", "Rent"];
    var accounts = ["Bank", "Credit"];
    var external = ["Employer", "Landlord", "Shop"];
    function budgetOf(account) {
        if (categories.includes(account) || accounts.includes(account))
            return "Budget";
        return account;
    }

    var rows = [];
    var tbody = document.getElementsByTagName("table")[0].children[0];
    var adder_row = document.getElementById("adder-row");

    var none = () => E('option', { value: '' });
    var option = value => E('option', value);

    function findRow(input) {
        return rows.findIndex(
            ({ account, category, moved, transferred }) =>
                [account, category, moved, transferred].includes(input));
    }

    function addRow(event) {
        var account = E('select', { change: accountChanged },
            none(), ...accounts.map(option), ...external.map(option));
        var category = E('select', { change: categoryChanged },
            none(), ...categories.map(option), ...external.map(option));
        var moved = E('input', {
            size: 7, input: amountChanged,
            blur: suggestAmounts
        });
        var transferred = E('input', {
            size: 7, input: amountChanged,
            blur: suggestAmounts
        });

        var row = { account, category, moved, transferred };
        rows.push(row);

        var td = element => E('td', element);
        var tr = E('tr', ...[account, category, moved, transferred].map(td));
        tbody.insertBefore(tr, adder_row);
        if (event) {
            account.focus({ focusVisible: true });
        }
        return row;
    }

    function suggest(element, value) {
        const suggested = element.classList.contains('suggested');
        const unselected = element.value === "" || suggested;
        if (value && unselected && document.activeElement !== element) {
            element.value = value;
            element.classList.add('suggested');
        }
        if (!value && suggested) {
            element.value = '';
            element.classList.remove('suggested');
        }
    }

    function accountChanged({ target }) {
        // Enforce uniqueness
        if (target.value) {
            for (var { account } of rows) {
                if (account !== target && account.value === target.value) {
                    account.value = "";
                    accountChanged({ target: account });
                }
            }
        }

        var { category } = rows[findRow(target)];
        suggest(category, external.includes(target.value) ? target.value : '');
        suggestAmounts();
    }

    function categoryChanged({ target }) {
        target.classList.remove('suggested');

        // Enforce uniqueness
        if (target.value) {
            for (var { category } of rows) {
                if (category !== target && category.value === target.value) {
                    category.value = "";
                    categoryChanged({ target: category });
                }
            }
        }

        suggestAmounts();
    }

    function amountChanged({ target }) {
        target.classList.remove('suggested');
        suggestAmounts();
    }

    function suggestAmounts() {
        for (var { moved, transferred } of rows) {
            suggest(moved, '');
            suggest(transferred, '');
        }
        for (var { account, category, moved, transferred } of rows) {
            if (account.value && category.value) {
                if (!isNaN(transferred.value))
                    suggest(moved, transferred.value);
                if (!isNaN(moved.value))
                    suggest(transferred, moved.value);
            }
        }
        var to_category = [];
        var category_total = 0;
        var to_account = [];
        var account_total = 0;
        for (var { account, category, moved, transferred } of rows) {
            if (category.value) {
                if (transferred.value) {
                    category_total += +transferred.value;
                } else {
                    to_category.push(transferred);
                }
            }
            if (account.value) {
                if (moved.value) {
                    account_total += +moved.value;
                } else {
                    to_account.push(moved);
                }
            }
        }
        if (!isNaN(-category_total) && to_category.length === 1) {
            suggest(to_category[0], -category_total);
        }
        if (!isNaN(-account_total) && to_account.length === 1) {
            suggest(to_account[0], -account_total);
        }
    }

    document.getElementById('addrow').addEventListener('click', addRow);

    addRow();
    addRow();
</script>
